{"version":3,"file":"featureTable.js","sourceRoot":"","sources":["../../src/vector/featureTable.ts"],"names":[],"mappings":"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","sourcesContent":["import { type Geometry, type GeometryVector } from \"./geometry/geometryVector\";\nimport type Vector from \"./vector\";\nimport { type IntVector } from \"./intVector\";\nimport { IntFlatVector } from \"./flat/intFlatVector\";\nimport { DoubleFlatVector } from \"./flat/doubleFlatVector\";\nimport { IntSequenceVector } from \"./sequence/intSequenceVector\";\nimport { IntConstVector } from \"./constant/intConstVector\";\nimport { type GpuVector } from \"./geometry/gpuVector\";\n\nexport interface Feature {\n    id: number | bigint;\n    geometry: Geometry;\n    properties: { [key: string]: unknown };\n}\n\nexport default class FeatureTable implements Iterable<Feature> {\n    private propertyVectorsMap: Map<string, Vector>;\n\n    constructor(\n        private readonly _name: string,\n        private readonly _geometryVector: GeometryVector | GpuVector,\n        private readonly _idVector?: IntVector,\n        private readonly _propertyVectors?: Vector[],\n        private readonly _extent = 4096,\n    ) {}\n\n    get name(): string {\n        return this._name;\n    }\n\n    get idVector(): IntVector {\n        return this._idVector;\n    }\n\n    get geometryVector(): GeometryVector | GpuVector {\n        return this._geometryVector;\n    }\n\n    get propertyVectors(): Vector[] {\n        return this._propertyVectors;\n    }\n\n    getPropertyVector(name: string): Vector {\n        if (!this.propertyVectorsMap) {\n            this.propertyVectorsMap = new Map(this._propertyVectors.map((vector) => [vector.name, vector]));\n        }\n\n        return this.propertyVectorsMap.get(name);\n    }\n\n    *[Symbol.iterator](): Iterator<Feature> {\n        const geometryIterator = this.geometryVector[Symbol.iterator]();\n        let index = 0;\n\n        while (index < this.numFeatures) {\n            let id;\n            if (this.idVector) {\n                id = this.containsMaxSaveIntegerValues(this.idVector)\n                    ? Number(this.idVector.getValue(index))\n                    : this.idVector.getValue(index);\n            }\n\n            const geometry = geometryIterator?.next().value;\n\n            const properties: { [key: string]: unknown } = {};\n            for (const propertyColumn of this.propertyVectors) {\n                if (!propertyColumn) {\n                    continue;\n                }\n\n                const columnName = propertyColumn.name;\n                const propertyValue = propertyColumn.getValue(index);\n                if (propertyValue !== null) {\n                    properties[columnName] = propertyValue;\n                }\n            }\n\n            index++;\n            yield { id, geometry, properties };\n        }\n    }\n\n    get numFeatures(): number {\n        return this.geometryVector.numGeometries;\n    }\n\n    get extent(): number {\n        return this._extent;\n    }\n\n    /**\n     * Returns all features as an array\n     */\n    getFeatures(): Feature[] {\n        const features: Feature[] = [];\n        const geometries = this.geometryVector.getGeometries();\n\n        for (let i = 0; i < this.numFeatures; i++) {\n            let id;\n            if (this.idVector) {\n                id = this.containsMaxSaveIntegerValues(this.idVector)\n                    ? Number(this.idVector.getValue(i))\n                    : this.idVector.getValue(i);\n            }\n\n            const geometry = {\n                coordinates: geometries[i],\n                type: this.geometryVector.geometryType(i),\n            };\n\n            const properties: { [key: string]: unknown } = {};\n            for (const propertyColumn of this.propertyVectors) {\n                if (!propertyColumn) continue;\n                const columnName = propertyColumn.name;\n                const propertyValue = propertyColumn.getValue(i);\n                if (propertyValue !== null) {\n                    properties[columnName] = propertyValue;\n                }\n            }\n\n            features.push({ id, geometry, properties });\n        }\n        return features;\n    }\n\n    private containsMaxSaveIntegerValues(intVector: IntVector) {\n        return (\n            intVector instanceof IntFlatVector ||\n            (intVector instanceof IntConstVector && intVector instanceof IntSequenceVector) ||\n            intVector instanceof DoubleFlatVector\n        );\n    }\n}\n"]}